name: Main work flow
on: workflow_dispatch
jobs:
    infrastructure-creation:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            actions: write
        defaults:
            run:
                shell: bash
                working-directory: ./infrastructure

        outputs:
          private_key: ${{steps.pem-key.outcome.private_key}}

        steps:
            - name: Code Checkout
              uses: actions/checkout@v4

            - name: AWS configure
              uses: aws-actions/configure-aws-credentials@v4.1.0
              with:
                aws-access-key-id:  ${{secrets.AWS_ACCESS_KEY_ID}}
                aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
                aws-region: ${{secrets.AWS_REGION}}

            - name: Setup terraform
              uses: hashicorp/setup-terraform@v3

            - name: Terraform init
              id: init
              run: terraform init -backend-config="bucket=${{secrets.TF_STATE_BUCKET}}"

            - name: Terraform format
              id: fmt
              run: terraform fmt -check

            - name: Terrafrom Validate
              id: validate
              run: terraform validate

            - name: Terraform plan
              id: plan
              run: terraform plan -no-color -input=false -out planfile

            - name: Terrafrom plan check
              if: steps.plan.outcome == 'failure'
              run: exit 1

            - name: Terrafrom apply
            #   if: github.ref == 'refs/heads/stage' && github.event_name=='push'
              run: terraform apply -no-color -auto-approve -input=false -parallelism=1  planfile

            - name: Get private key from terraform output
              id: pem-key
              run: |
                PRIVATE_KEY=$(terraform output -raw private_key)
                echo "::add-mask::$PRIVATE_KEY"
                echo "private_key=$PRIVATE_KEY" >> $GITHUB_OUTPUT

            - name: Upload Anisble Inventory as Artifact
              uses: actions/upload-artifact@v4
              with:
                name: ansible-inventory
                path: ./ansible/inventory.ini

    ansible-configuration:
        runs-on: ubuntu-latest
        needs: infrastructure-creation
        defaults:
            run:
                shell: bash
                working-directory: ./ansible

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Download Inventory file from artifactory
              uses: actions/download-artifact@v4
              with:
                name: ansible-inventory
                path: ./ansible

            - name: Load Private Key into SSH Agent
              uses: webfactory/ssh-agent@v0.9.0
              with:
                ssh-private-key: ${{ needs.infrastructure-creation.outputs.private_key }}

            - name: Run ansible playbook
              run: |
                ansible web -m ping
